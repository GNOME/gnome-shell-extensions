# SPDX-FileCopyrightText: 2017 Florian MÃ¼llner <fmuellner@gnome.org>
#
# SPDX-License-Identifier: GPL-2.0-or-later

include:
  - project: Infrastructure/freedesktop-ci-templates
    file: templates/fedora.yml
  - project: Infrastructure/freedesktop-ci-templates
    file: templates/ci-fairy.yml
  - project: GNOME/citemplates
    file: templates/default-rules.yml
  - component: gitlab.gnome.org/GNOME/citemplates/release-service@master
    inputs:
      job-stage: deploy
      dist-job-name: fedora-dist-tarball
      tarball-artifact-path: "$TARBALL_ARTIFACT_PATH"

stages:
  - pre-review
  - prepare
  - review
  - build
  - deploy

default:
  image: registry.gitlab.gnome.org/gnome/gnome-shell/fedora/43:2025-09-10.1

variables:
  FDO_UPSTREAM_REPO: GNOME/gnome-shell-extensions
  MESON_BUILD_DIR: build
  TARBALL_ARTIFACT_PATH: "${MESON_BUILD_DIR}/meson-dist/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.tar.xz"

.pipeline-guard:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH =~ /^gnome-[0-9-]+$/'
    - when: 'manual'

.prereview-req:
  needs:
    - check-commit-log
    - check-merge-request

check-commit-log:
  extends:
    - .fdo.ci-fairy
  stage: pre-review
  script:
    - if [[ x"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" != "x" ]] ;
      then
        ci-fairy check-commits --junit-xml=commit-message-junit-report.xml ;
      else
        echo "Not a merge request" ;
      fi
  rules:
    - !reference [.pipeline-guard, rules]
  artifacts:
    expire_in: 1 week
    paths:
      - commit-message-junit-report.xml
    reports:
      junit: commit-message-junit-report.xml

check-merge-request:
  extends:
    - .fdo.ci-fairy
  stage: pre-review
  script:
    - if [[ x"$CI_MERGE_REQUEST_TARGET_BRANCH_NAME" != "x" ]] ;
      then
        ci-fairy check-merge-request --require-allow-collaboration --junit-xml=check-merge-request-report.xml ;
      else
        echo "Not a merge request" ;
      fi
  rules:
    - !reference [.pipeline-guard, rules]
  artifacts:
    expire_in: 1 week
    paths:
      - check-merge-request-report.xml
    reports:
      junit: check-merge-request-report.xml

check-reuse:
  stage: pre-review
  image:
    name: fsfe/reuse:latest
    entrypoint: [""]
  script:
    - reuse lint

js-check:
  stage: review
  needs:
    - !reference [.prereview-req, needs]
  script:
    - gjs-check-syntax

eslint:
  stage: review
  needs:
    - !reference [.prereview-req, needs]
  variables:
    LINT_LOG: "eslint-report.xml"
  script:
    - ./tools/run-eslint.sh --output-file "$LINT_LOG" --format junit --stdout
  artifacts:
    reports:
      junit: "$LINT_LOG"

potfile-js-check:
  stage: review
  needs:
    - !reference [.prereview-req, needs]
  script:
    - gjs-check-potfiles
  artifacts:
    reports:
      junit: gjs-check-potfiles.junit.xml

build-bundles:
  stage: build
  needs:
    - !reference [.prereview-req, needs]
  script:
    - ./export-zips.sh
  artifacts:
    name: 'Extension bundles'
    expose_as: 'Get Extension bundles here'
    paths:
      - zip-files/

dist-bundles:
  stage: deploy
  needs:
    - build-bundles
  script:
    - gnome-extensions upload --accept-tos --user "$EGO_USER" --password "$EGO_PASSWORD" zip-files/*.zip
  rules:
    - if: '$CI_COMMIT_TAG'

fedora-build:
  stage: build
  needs:
    - !reference [.prereview-req, needs]
  script:
    - meson setup "$MESON_BUILD_DIR" --werror -Dextension_set=all -Dclassic_mode=true
    - meson compile -C "$MESON_BUILD_DIR"
    - meson test -C "$MESON_BUILD_DIR"
    - meson install -C "$MESON_BUILD_DIR"
  artifacts:
    paths:
      - "$MESON_BUILD_DIR"

fedora-dist:
  stage: deploy
  needs:
    - fedora-build
  variables:
    GIT_SUBMODULE_STRATEGY: normal
  script:
    - meson dist -C "$MESON_BUILD_DIR"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "**/meson.build"
        - meson/*

fedora-dist-tarball:
  extends: fedora-dist
  artifacts:
    expose_as: 'Get tarball here'
    name: "${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}"
    when: always
    paths:
      - "$TARBALL_ARTIFACT_PATH"
  rules:
    - if: '$CI_COMMIT_TAG'
